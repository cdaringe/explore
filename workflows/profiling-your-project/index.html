<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
 <head><title>Profiling your Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta charset="utf-8"/>
  <meta name="description"
   content="Profile the memory and performance of your application"/>
  <link rel="stylesheet"
   href="https://fonts.googleapis.com/css2?family=Roboto+Mono&amp;family=Ubuntu:ital,wght@0,400;0,700;1,400&amp;display=swap"
   />
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/base.css"/>
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/grids-core.css"/>
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/grids-units.css"/>
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/grids-responsive.css"/>
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/menus-core.css"/>
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/menus-dropdown.css"/>
  <link rel="stylesheet" href="/css/main.css"/>
  <link rel="stylesheet"
   href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/styles/gruvbox-dark.min.css"
   />
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js">
  </script>
  <script
   src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js"
   >
  </script>
  <script charset="UTF-8"
   src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/languages/ocaml.min.js"
   >
  </script><script>hljs.initHighlightingOnLoad();</script>
 </head>
 <body>
             
  <header>
                  
   <a class="skip-to-content" href="#main"> Skip to main content </a>
   <div class="pure-g">
                             
    <div class="pure-u-1-3">
                                    
     <a class="title-link" href="/">
                                              
      <h2 style="text-align: center">Explore OCaml</h2>
                                                               
     </a>
               
    </div>
                
    <div class="pure-u-1-3"></div>
                                          
    <nav class="pure-hidden-xs pure-hidden-sm pure-u-1-3 flex-col flex-vert">
     
               
     <ul class="flex-row flex-center nav-ul">
      <li class="nav-button">
                                           
       <a href="/platform">
                                           Tools 
                                         </a>
       
                   
      </li>
      <li class="nav-button">
                                           
       <a href="/users">
                                        Users
                                      </a>
       
                   
      </li>
      <li class="nav-button">
                                           
       <a href="/libraries">
                                            Libraries
                                          </a>
       
                   
      </li>
     </ul>
                  
    </nav>
                  
    <nav class="pure-hidden-md pure-hidden-lg pure-hidden-xl pure-menu
     pure-menu-horizontal flex-col flex-vert pure-u-1-3">
                                                                   
     <ul class="pure-menu-list" style="text-align: center">
      <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
       
                   <a href="#" id="menuLink1" class="pure-menu-link">Menu</a>
       
                   
       <ul class="pure-menu-children mob-menu-list">
        <li class="pure-menu-item mob-menu-item">
                                                                   
         <a href="/platform">
                                                 Tools 
                                               </a>
         
                         
        </li>
        <li class="pure-menu-item mob-menu-item">
                                                                   
         <a href="/users">
                                              Users
                                            </a>
         
                         
        </li>
        <li class="pure-menu-item mob-menu-item">
                                                                   
         <a href="/libraries">
                                                Libraries
                                                
         </a>
                             
        </li>
       </ul>
                        
      </li>
     </ul>
                  
    </nav>
              
   </div>
               
  </header>
                   
  <div class="pure-g">
                                
   <div class="pure-u-1-12 pure-u-md-1-4">
                                                      
    <div class="pure-hidden-xs pure-hidden-sm pure-hidden-md toc-container
     sticky">
     <ul class="toc">
      <li>
       <ul class="toc">
        <li>
         <a class="toc-item-1" href="#profiling-your-project">
          Profiling your Project
         </a>
         <ul class="toc">
          <li><a class="toc-item-2" href="#overview">Overview</a></li>
         </ul>
         <ul class="toc">
          <li>
           <a class="toc-item-2" href="#recommended-workflow">
            Recommended Workflow
           </a>
           <ul class="toc">
            <li><a class="toc-item-3" href="#memory">Memory</a></li>
           </ul>
           <ul class="toc">
            <li><a class="toc-item-3" href="#performance">Performance</a>
            </li>
           </ul>
          </li>
         </ul>
         <ul class="toc">
          <li><a class="toc-item-2" href="#alternatives">Alternatives</a>
           <ul class="toc">
            <li>
             <a class="toc-item-3" href="#real-world-examples">
              Real World Examples
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </div>
                    
   </div>
                   
   <div class="pure-u-5-6 pure-u-md-1-2">
                                                     
    <main id="main"> 
     <h1 id="profiling-your-project">Profiling your Project</h1>
<p><em>Last Updated: 27, July 2020 at 09:35:49</em></p>
<hr />
<h2 id="overview">Overview</h2>
<hr />
<p>For profiling programs there tend to be two main properties that most developers care about:</p>
<ol>
<li>Performance
</li>
<li>Memory Usage
</li>
</ol>
<p>OCaml is a garbage-collected programming language, but there are ways to alleviate the the strain on the GC. There is also good support for profiling the performance of your program to find the sections that are consuming the most execution time.</p>
<h2 id="recommended-workflow">Recommended Workflow</h2>
<hr />
<h3 id="memory">Memory</h3>
<p>To enable memory profiling (much like with fuzzing) you need to install specific variants of the OCaml compiler - in particular it must have <code>+spacetime</code> in its package name.</p>
<p>Spacetime monitors the OCaml heap - this is where values are stored if they are not represented as unboxed integers. You can set the interval you want spacetime to monitor at by issuing:</p>
<pre><code class="language-bash">ocamlopt -o &lt;executable&gt; somefile.ml
OCAML_SPACETIME_INTERVAL=1000 &lt;executable&gt;
</code></pre>
<p><em><strong>Note: this is a little dependent on what shell you use, for example with fish you will have to preprend <code>env</code> to the <code>OCAML...</code> command.</strong></em></p>
<p>The workflow is very similar to <code>gprof</code> with OCaml in that you run the instrumented version which produces additional files, and then use a tool to make sense of the results. If we have some <code>mem_test.ml</code> file we want to profile, the series of commands may look something like this:</p>
<pre><code class="language-bash"># Create a new spacetime enable switch 
opam switch create 4.10.0+spacetime
eval $(opam env)

# Install the memory profiling view
opam install prof_spacetime 

# Compile your code
ocamlopt -o mem_test mem_test.ml

# Run the executable with profiling enabled 
OCAML_SPACETIME_INTERVAL=1000 ./mem_test

# Process the results - fill in your unique &lt;id&gt;
prof_spacetime process spacetime-&lt;id&gt;

# View the results in a browser 
prof_spacetime serve -p spacetime-&lt;id&gt;.p
</code></pre>
<h3 id="performance">Performance</h3>
<p>Perf is a tool that can be used to profile programs without any additional instrumentation.</p>
<h2 id="alternatives">Alternatives</h2>
<hr />
<h3>Performance with <code>gprof</code></h3>
<p><em><strong>Note: gprof is only supported up to version 4.08.0 of the OCaml compiler. Additionally, because of the required linking options with Clang and MacOS you may encounter the following error &quot;<strong>the clang compiler does not support -pg option on versions of OS X 10.9 and later</strong>&quot;</strong></em></p>
<p><a href="https://sourceware.org/binutils/docs/gprof/">Gprof</a> is the GNU profiler and can be used to track how much time is spent in different parts of your application. Like memory profiling this requires additional instrumentation in your binaries. However, unlike spacetime profiling, it doesn't require a specific switch, just some flags to be set.</p>
<p>In the simplest case (compiling by hand) the following is sufficient:</p>
<pre><code class="language-bash"># Create compatible compiler in new switch  
opam switch create 4.08.0
eval $(opam env)

# Compile the code with profiling enabled 
ocamlopt -p -o test test.ml 

# Run the code
./test

# View the results 
gprof test | less 
</code></pre>
<p>If you are using dune to build your project you will need something like the following in your dune file at the root of your project:</p>
<pre><code>(env
 (perf
  (flags (:standard -p))))
</code></pre>
<p>There after the process is very similar:</p>
<pre><code># Compile the program with profiling enabled 
dune build --profile perf 

# Run the program
_build/default/test.exe

# See the profiling results 
gprof _build/default/test.exe | less 
</code></pre>
<h3 id="real-world-examples">Real World Examples</h3>
<hr />

     <h3>Resources</h3>
     <ol>
      <li>
       <a
        href="https://github.com/ocaml-bench/notes/blob/master/profiling_notes.md"
        >Profiling Notes
       </a> - 
       Notes on profiling OCaml code in terms of memory and performance by
       Tom Kelly and Sadiq Jaffer
      </li>
      <li>
       <a href="https://blog.janestreet.com/a-brief-trip-through-spacetime/">
        A Brief Trip through Space Time
       </a> - 
       A thorough explanation of how to use the OCaml Spactime compiler
       variant for memory profiling your OCaml code by Leo White
      </li>
     </ol>
    </main>
                     
   </div>
                 
  </div>
            
          
        </body>
</html>
