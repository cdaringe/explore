<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
 <head><title>Incorporating non-OCaml Code into your Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta charset="utf-8"/>
  <meta name="description" content="Add C code to your OCaml project"/>
  <link rel="stylesheet"
   href="https://fonts.googleapis.com/css2?family=Roboto+Mono&amp;family=Ubuntu:ital,wght@0,400;0,700;1,400&amp;display=swap"
   />
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/base.css"/>
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/grids-core.css"/>
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/grids-units.css"/>
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/grids-responsive.css"/>
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/menus-core.css"/>
  <link rel="stylesheet"
   href="https://unpkg.com/purecss@2.0.0/build/menus-dropdown.css"/>
  <link rel="stylesheet" href="/css/main.css"/>
  <link rel="stylesheet"
   href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/styles/gruvbox-dark.min.css"
   />
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js">
  </script>
  <script
   src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js"
   >
  </script>
  <script charset="UTF-8"
   src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/languages/ocaml.min.js"
   >
  </script><script>hljs.initHighlightingOnLoad();</script>
 </head>
 <body>
             
  <header>
                  
   <a class="skip-to-content" href="#main"> Skip to main content </a>
   <div class="pure-g">
                             
    <div class="pure-u-1-3">
                                    
     <a class="title-link" href="/">
                                              
      <h2 style="text-align: center">Explore OCaml</h2>
                                                               
     </a>
               
    </div>
                
    <div class="pure-u-1-3"></div>
                                          
    <nav class="pure-hidden-xs pure-hidden-sm pure-u-1-3 flex-col flex-vert">
     
               
     <ul class="flex-row flex-center nav-ul">
      <li class="nav-button">
                                           
       <a href="/platform">
                                           Tools 
                                         </a>
       
                   
      </li>
      <li class="nav-button">
                                           
       <a href="/users">
                                        Users
                                      </a>
       
                   
      </li>
      <li class="nav-button">
                                           
       <a href="/libraries">
                                            Libraries
                                          </a>
       
                   
      </li>
     </ul>
                  
    </nav>
                  
    <nav class="pure-hidden-md pure-hidden-lg pure-hidden-xl pure-menu
     pure-menu-horizontal flex-col flex-vert pure-u-1-3">
                                                                   
     <ul class="pure-menu-list" style="text-align: center">
      <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
       
                   <a href="#" id="menuLink1" class="pure-menu-link">Menu</a>
       
                   
       <ul class="pure-menu-children mob-menu-list">
        <li class="pure-menu-item mob-menu-item">
                                                                   
         <a href="/platform">
                                                 Tools 
                                               </a>
         
                         
        </li>
        <li class="pure-menu-item mob-menu-item">
                                                                   
         <a href="/users">
                                              Users
                                            </a>
         
                         
        </li>
        <li class="pure-menu-item mob-menu-item">
                                                                   
         <a href="/libraries">
                                                Libraries
                                                
         </a>
                             
        </li>
       </ul>
                        
      </li>
     </ul>
                  
    </nav>
              
   </div>
               
  </header>
                   
  <div class="pure-g">
                                
   <div class="pure-u-1-12 pure-u-md-1-4">
                                                      
    <div class="pure-hidden-xs pure-hidden-sm pure-hidden-md toc-container
     sticky">
     <ul class="toc">
      <li>
       <ul class="toc">
        <li>
         <a class="toc-link toc-item-1"
          href="#incorporating-non-ocaml-code-into-your-project">
          Incorporating non-OCaml Code into your Project
         </a>
         <ul class="toc">
          <li class="toc-li">
           <a class="toc-link toc-item-2" href="#overview">Overview</a>
          </li>
         </ul>
         <ul class="toc">
          <li>
           <a class="toc-link toc-item-2" href="#recommended-workflow">
            Recommended Workflow
           </a>
           <ul class="toc">
            <li class="toc-li">
             <a class="toc-link toc-item-3" href="#ocaml-internals">
              OCaml Internals
             </a>
            </li>
           </ul>
           <ul class="toc">
            <li class="toc-li">
             <a class="toc-link toc-item-3"
              href="#interacting-with-c-from-ocaml">
              Interacting with C from OCaml
             </a>
            </li>
           </ul>
           <ul class="toc">
            <li class="toc-li">
             <a class="toc-link toc-item-3"
              href="#interacting-with-ocaml-from-c">
              Interacting with OCaml from C
             </a>
            </li>
           </ul>
          </li>
         </ul>
         <ul class="toc">
          <li class="toc-li">
           <a class="toc-link toc-item-2" href="#real-world-examples">
            Real World Examples
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </div>
                    
   </div>
                   
   <div class="pure-u-5-6 pure-u-md-1-2">
                                                     
    <main id="main"> 
     <h1 id="incorporating-non-ocaml-code-into-your-project">Incorporating non-OCaml Code into your Project</h1>
<p><em>Last Updated: 05, August 2020 at 15:14:54</em></p>
<div><p>Platform tools: <span class="details-tools"><a href="/platform/dune">Dune</a></span></p></div>
<h2 id="overview">Overview</h2>
<p>Sometimes OCaml just can't do what lower level languages can do or you want to use pre-existing code written in C or Rust from OCaml.</p>
<h2 id="recommended-workflow">Recommended Workflow</h2>
<h3 id="ocaml-internals">OCaml Internals</h3>
<p>Programming languages must have a representation of data at runtime, for example how should OCaml represent <code>type camel = Dromedary of int</code> in memory? When you interface between two languages much of the battle is converting in-and-out of each programming language's internal data represenation. A <a href="https://caml.inria.fr/pub/docs/manual-ocaml/intfc.html#s%3Ac-ocaml-datatype-repr">detailed introduction</a> of OCaml's internal data representation is given in the manual, what follows is a brief summary.</p>
<p>OCaml has a uniform memory representation where everything is a word-sized value. These can either be immediates (represented as unboxed integers) or non-immediates (pointers to a block stored in the OCaml or the C heap). Boxing is the process of wrapping additional meta-data around a value much like IP packets and their header.</p>
<p><img src="/images/data-repr.jpg" alt="OCaml runtime data represenation" /></p>
<p>To distinguish between immediates and non-immediates (pointers), OCaml uses a tag bit in the least significant bit as a flag. When it is set to 1 this indicates an immediate, otherwise it should be interpretted as a pointer. This means on a 32-bit machine OCaml integers can only be 31-bit. The runtime value of the number <code>7</code> in OCaml is actually <code>15</code>. The conversion function can be seen <a href="https://github.com/ocaml/ocaml/blob/trunk/runtime/caml/mlvalues.h#L75">here</a> in the OCaml compiler.</p>
<p>Integers are not the only values represented as immediates. Normal and polymorphic variants with constant constructors are represented as immediates, the latter as a hash of the constructor name. The built-in boolen values are also immediates i.e. true is <code>1</code> (which in OCaml is <code>3</code>) and false is <code>0</code> (<code>1</code> in OCaml).</p>
<pre><code class="language-ocaml"># type vehicle = Car | Bicycle of string | Truck 
type vehicle = Car | Bicycle of string | Truck
# type poly = [`String | `Int]
type poly = [ `Int | `String ]
# true
- : bool = true
</code></pre>
<p>Variants with non-constant constructors are heap allocated as blocks (only the non-constant ones). Blocks in the heap start with a one-word header, either 32 or 64-bit depending on thearchitecture, which contains information about the length of the value (22 or 54 bits), 2 bits for a colour which is used in garbage collection and 8 bits for a multi-purpose tag byte to indicate what the block is. The type unsafe <code>Obj</code> module lets you inspect the runtime information of values.</p>
<pre><code class="language-ocaml"># Obj.tag (Obj.repr Car)
- : int = 1000
# Obj.is_int (Obj.magic Car)
- : bool = true
# Obj.tag (Obj.repr (Bicycle &quot;electric&quot;))
- : int = 0
# Obj.is_block (Obj.magic (Bicycle &quot;electric&quot;))
- : bool = true
# Obj.tag (Obj.repr `String)
- : int = 1000
# Obj.tag (Obj.repr (fun x -&gt; x)) 
- : int = 247
</code></pre>
<h3 id="interacting-with-c-from-ocaml">Interacting with C from OCaml</h3>
<p>To interact with C code you need to use the Foreign Function Interface (FFI) in OCaml and make some changes to your <code>dune</code> files to incorporate the extra code. To use a foreign C function in OCaml you need to add:</p>
<pre><code class="language-ocaml">external &lt;ocaml-name&gt; : &lt;type-of-function&gt; = &quot;&lt;c-function-name&gt;&quot;
</code></pre>
<p>The C function will take OCaml values as arguments (which will be encoded using the data representation previously described). For example if we want to have an external C <code>add</code> function the C file would be.</p>
<div><div><p class="toolbar"><a href="https://github.com/ocaml-explore/explore/tree/trunk/content/workflows/incorporating-non-ocaml-code-into-your-project/examples/c-from-ocaml/add.c">Source Code</a></p></div><pre><code class="language-c">#include &lt;caml/mlvalues.h&gt;

value add_c(value a, value b)
{
  return Val_long(Long_val(a) + (Long_val(b)));
}
</code></pre>
</div><p>To access the code in OCaml we define an external <code>add</code> function and give it proper OCaml types within our <code>main.ml</code> file.</p>
<div><div><p class="toolbar"><a href="https://github.com/ocaml-explore/explore/tree/trunk/content/workflows/incorporating-non-ocaml-code-into-your-project/examples/c-from-ocaml/main.ml">Source Code</a></p></div><pre><code class="language-ocaml">external add : int -&gt; int -&gt; int = &quot;add_c&quot;

let () = print_int (add 10 10)
</code></pre>
</div><p>Finally we compile everything using dune and the <em>foreign_stubs</em> optional field.</p>
<div><div><p class="toolbar"><a href="https://github.com/ocaml-explore/explore/tree/trunk/content/workflows/incorporating-non-ocaml-code-into-your-project/examples/c-from-ocaml/dune">Source Code</a></p></div><pre><code>(executable
 (name main)
 (foreign_stubs
  (language c)
  (names add)))
</code></pre>
</div><h3 id="interacting-with-ocaml-from-c">Interacting with OCaml from C</h3>
<p>Sometimes you might want to do the inverse and access parts on an <a href="https://ocaml.org/releases/4.10/htmlman/intfc.html">OCaml program from a C program</a>. This still suffers from the data represenation shuffling that might need to take place. There are two main ways that you may want to call OCaml from C. Either as callbacks (OCaml calls C which calls OCaml) or just directly from a main C program. The latter requires you to initialise the OCaml code by calling <code>caml_main</code>.</p>
<p>In order for C to find OCaml functions you need to register them as callbacks using <code>Callback.register</code>. This <a href="https://github.com/patricoferris/ocaml-c-example">small example</a> calls a fibonacci function written in OCaml from C. Note the additional C compiler parameters in the Makefile for linking in the standard library and only producing an object OCaml file.</p>
<h2 id="real-world-examples">Real World Examples</h2>
<p><a href="https://github.com/mirage/digestif/tree/master/src-c/native">Digestif</a> implements many common hashing algorithms both in C and OCaml.</p>
<p><a href="https://github.com/mirage/ocaml-cstruct">Cstruct</a>  is a library that allows you to read and write structures from the C programming language. It is used in many applications for handling things like packets, for example in the <a href="https://github.com/mirage/ocaml-git">Git</a> implementation in pure OCaml.</p>

     <h3>Resources</h3>
     <ol>
      <li>
       <a href="https://rwmj.wordpress.com/2009/08/04/ocaml-internals/">
        A Beginners Guide to OCaml Internals
       </a> - 
       A series of great articles explaining the internal respresentation of
       values in OCaml, useful for understanding things like memory profiling
       and GC.
      </li>
      <li>
       <a
        href="https://caml.inria.fr/pub/docs/oreilly-book/html/book-ora114.html"
        >Communication between C and Objective Caml
       </a> - 
       A chapter on how C and OCaml talk to each other with some useful
       diagrams too
      </li>
     </ol>
     <p id="edit">
      <span class="details">
       <a
        href="https://github.com/ocaml-explore/explore/tree/trunk/content/workflows/incorporating-non-ocaml-code-into-your-project/index.md"
        >Edit this page on Github
       </a>
      </span>
     </p>
    </main>
                     
   </div>
                 
  </div>
            
          
        </body>
</html>
